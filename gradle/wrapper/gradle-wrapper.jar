package com.ht.text2speech;

import androidx.appcompat.app.AppCompatActivity;

import android.media.AudioManager;
import android.media.MediaPlayer;
import android.os.Bundle;
import android.os.Handler;
import android.os.Looper;
import android.os.Message;
import android.util.Log;
import android.util.SparseArray;

import java.io.IOException;
import java.util.List;

import at.huber.youtubeExtractor.VideoMeta;
import at.huber.youtubeExtractor.YouTubeExtractor;
import at.huber.youtubeExtractor.YtFile;
import fi.iki.elonen.NanoHTTPD;

public class MainActivity extends AppCompatActivity {

    static ControllerThread controllerThread;
    static Model model;

    final String TAG = "ahihi";

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        controllerThread = new ControllerThread();
        controllerThread.start();

        model = new Model();

        try {
            new HttpServer(controllerThread);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    class AddTrack2List implements Runnable {

        Bundle newTrack;

        AddTrack2List(Bundle trackInfo) {
            newTrack = trackInfo;
        }

        @Override
        public void run() {
            model.getTrackList("ahihi").add(newTrack);
        }
    }

    class Model {
        List<Bundle> mTrackList;

        public List<Bundle> getTrackList(String listName) {
            return mTrackList;
        }
    }

    class RequestYtbRunnable implements Runnable {
        String youtubeVideoId;
        final String strYoutubeBase = "http://youtube.com/watch?v=";

        RequestYtbRunnable(String ytbVideoId) {
            youtubeVideoId = strYoutubeBase + ytbVideoId;
            return;
        }

        @Override
        public void run() {
            // Request a string response from the provided URL.
//            StringRequest stringRequest = new StringRequest(Request.Method.GET, youtubeVideoId,
//                    new Response.Listener<String>() {
//                        @Override
//                        public void onResponse(String response) {
//                            try {
//                                String afterDecode = URLDecoder.decode(response, "UTF-8");
//
//                                int idx1 = afterDecode.indexOf("itag\":140");
//                                if(idx1 < 0) throw new Exception("Parse itag fail");
//                                idx1 = afterDecode.indexOf("https://", idx1);
//                                if(idx1 < 0) throw new Exception("Parse itag fail");
//                                int idx2 = afterDecode.indexOf("\"", idx1);
//                                if(idx2 < 0) throw new Exception("Parse itag fail");
//                                String src = afterDecode.substring(idx1, idx2).replace("\\u0026", "&");
//
//                                // assemble message
//                                Bundle b = new Bundle();
//                                b.putInt("type", ControllerThread.MSG_TYPE_SET_PLAYER_SOURCE_YOUTUBE);
//                                b.putString("src", src);
//                                Message msg = new Message();
//                                msg.setData(b);
//
//                                // send to controller thread
//                                controllerThread.mHandler.handleMessage(msg);
//
//                            } catch (Exception e) {
//                                e.printStackTrace();
//                                speechError();
//                            }
//                        }
//                    },
//                    new Response.ErrorListener() {
//                        @Override
//                        public void onErrorResponse(VolleyError error) {
//                            speechError();
//                        }
//                    });
//
//            Volley.newRequestQueue(MainActivity.this).add(stringRequest);

            new YouTubeExtractor(MainActivity.this) {
                @Override
                public void onExtractionComplete(SparseArray<YtFile> ytFiles, VideoMeta vMeta) {
                    if (ytFiles != null) {
                        int itag = 140;
                        String downloadUrl = ytFiles.get(itag).getUrl();
                        Log.d(TAG, "onExtractionComplete: " + downloadUrl);
                        Bundle b = new Bundle();
                        b.putInt("type", ControllerThread.MSG_TYPE_SET_PLAYER_SOURCE_YOUTUBE);
                        b.putString("src", downloadUrl);
                        Message msg = new Message();
                        msg.setData(b);
                        controllerThread.mHandler.handleMessage(msg);
                        Log.d(TAG, "setData: ");
                    }
                }
            }.extract(youtubeVideoId, false, false);
        }
    }

    class ControllerThread extends Thread {
        public Handler mHandler;

        MediaPlayer mainPlayer;

        public static final int MSG_TYPE_SET_PLAYER_SOURCE_YOUTUBE = 1;

        public void run() {
            Looper.prepare();

            mainPlayer = new MediaPlayer();

            mHandler = new Handler() {
                public void handleMessage(Message msg) {
                        try {
                            int msgType = msg.getData().getInt("type");

                            if(msgType == MSG_TYPE_SET_PLAYER_SOURCE_YOUTUBE) {
                                String src = msg.getData().getString("src");
                                Log.d(TAG, "handleMessage: " + src);

                                if(mainPlayer.isPlaying()) {
                                    mainPlayer.stop();
//                                    mainPlayer.release();
                                }

//                                mainPlayer = new MediaPlayer();
                                mainPlayer.setAudioStreamType(AudioManager.STREAM_MUSIC);
                                mainPlayer.setDataSource(src);
                                mainPlayer.prepare();
                                mainPlayer.start();
                            }
                        } catch (IOException e) {
                            e.printStackTrace();
                        }

                    }
                };
            Looper.loop();
        }
    }

    void speechError() {
        MediaPlayer.create(MainActivity.this, R.raw.error).start();
    }

    class Ip2Speech {
        MediaPlayer speechCham;
        MediaPlayer [] speechNumbers;

        String currentIp;
        Ip2Speech() {
            currentIp = "0";

            speechCham = MediaPlayer.create(MainActivity.this, R.raw.cham);
            speechNumbers = new MediaPlayer[10];

            speechNumbers[0] = MediaPlayer.create(MainActivity.this, R.raw.s0);
            speechNumbers[1] = MediaPlayer.create(MainActivity.this, R.raw.s1);
            speechNumbers[2] = MediaPlayer.create(MainActivity.this, R.raw.s2);
            speechNumbers[3] = MediaPlayer.create(MainActivity.this, R.raw.s3);
            speechNumbers[4] = MediaPlayer.create(MainActivity.this, R.raw.s4);
            speechNumbers[5] = MediaPlayer.create(MainActivity.this, R.raw.s5);
            speechNumbers[6] = MediaPlayer.create(MainActivity.this, R.raw.s6);
            speechNumbers[7] = MediaPlayer.create(MainActivity.this, R.raw.s7);
            speechNumbers[8] = MediaPlayer.create(MainActivity.this, R.raw.s8);
            speechNumbers[9] = MediaPlayer.create(MainActivity.this, R.raw.s9);
        }

        void speak() {
            new Thread(new Runnable() {
                @Override
                public void run() {
                    String ip = currentIp;
                    for(int i = 0; i < ip.length(); i++) {
                        char c = ip.charAt(i);
                        if(c == '.') {
                            speechCham.start();
                        }
                        else if('0' <= c && c <= '9') {
                            speechNumbers[c-48].start();
                        }
                        try {
                            Thread.sleep(700);
                        } catch (InterruptedException e) {
                            e.printStackTrace();
                            break;
                        }
                    }
                }
            }).start();
        }
    }

    class HttpServer extends NanoHTTPD {

        ControllerThread controllerThread;

        public HttpServer(ControllerThread _controllerThread) throws IOException {
            super(8080);
            start(NanoHTTPD.SOCKET_READ_TIMEOUT, false);
            controllerThread = _controllerThread;
        }

        @Override
        public Response serve(IHTTPSession session) {

            if (session.getMethod() == Method.GET) {
                try {
                    List<String> list = session.getParameters().get("vid");
                    if (list != null) {
                        controllerThread.mHandler.post(new RequestYtbRunnable(list.get(0)));
                    }
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }

            return newFixedLengthResponse(Response.Status.NOT_FOUND, MIME_PLAINTEXT,
                    "The requested resource does not exist");
        }
    }
}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          